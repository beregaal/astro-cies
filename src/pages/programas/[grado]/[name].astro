---
import type { GetStaticPaths } from "astro";
import BaseLayout from "@layouts/BaseLayout.astro";
import json_programas from "@data/programas.json";
import "@styles/views/programas.css";

import CiesSeccionProgramaHeader from "@components/programas/Header.astro";
import CiesSeccionProgramaForm from "@components/programas/Form.astro";

// Contenidos específicos
import CiesContenidoLicPsicologia from '@components/programas/contenido/LicPsicologia.astro';
import CiesContenidoMtrPsicomotricidad from '@components/programas/contenido/MtrPsicomotricidad.astro';
import CiesContenidoMtrPsicoterapia from '@components/programas/contenido/MtrPsicoterapia.astro';
import CiesContenidoDctInvPsicoanalitica from '@components/programas/contenido/DctPsicoanalitica.astro';
import CiesContenidoDctDesarrolloHumano from '@components/programas/contenido/DctDesarrolloHumano.astro';



const siteUrl = "https://cies.mx"; // ajustar
interface FaqItem {
  question: string;
  answer: string;
}
interface Programa {
  key: string;
  titulo: string;
  grado: string;
  descripcion: string;
  link: string;
  imgSrc: string;
  tituloSeo?: string;
  descripcionSeo?: string;
  faq?: FaqItem[];
}

// Genera las rutas estaticas desde json
export const getStaticPaths = (() => {
  return json_programas.map((p) => {
    // p.link: "/programas/maestria/psicoterapia-psicoanalitica"
    const parts = p.link.split("/").filter(Boolean); // ["programas","maestria","psicoterapia-psicoanalitica"]
    const grado = parts[1];
    const name = parts[2];
    return { params: { grado, name } };
  });
}) satisfies GetStaticPaths;

// Parametros de la ruta
const { grado, name } = Astro.params;

// Recupera información del programa
const programa = json_programas.find((p) => p.link.endsWith(`/${grado}/${name}`));
if (!programa) {
  throw new Error(`Programa no encontrado para /programas/${grado}/${name}`);
}

// Mapa de key -> componente de contenido
const contentMap: Record<string, any> = {
  'lic-psicologia': CiesContenidoLicPsicologia,
  'mtr-psicomotricidad': CiesContenidoMtrPsicomotricidad,
  'mtr-psicoterapia': CiesContenidoMtrPsicoterapia,
  'dct-investigacion': CiesContenidoDctInvPsicoanalitica,
  'dct-desarrollo-humano': CiesContenidoDctDesarrolloHumano
  // ...
};

// URL canónica de la página
const pageUrl = new URL(programa.link, siteUrl).toString();

// Título SEO (ej: "CIES | Licenciatura en Psicología")
const tituloCompleto = `${programa.grado} en ${programa.titulo}`;
const title = `CiES | ${tituloCompleto}`;

// Descripción SEO 
const description =
  programa.descripcionSeo ??
  programa.descripcion ??
  "Formación universitaria y de posgrado en psicología, educación y humanidades en CiES.";

// Breadcrumbs para Structured Data
const breadcrumbs = [
  { name: "Inicio", url: `${siteUrl}/` },
  { name: "Programas", url: `${siteUrl}/programas` },
  {
    name: programa.grado, // Licenciatura / Maestría / Doctorado
    url: `${siteUrl}/programas/${grado}`
  },
  { name: programa.titulo, url: pageUrl }
];

// Datos del Course para Structured Data
const courseData = {
  name: tituloCompleto,
  url: pageUrl,
  description,
  providerName: "Colegio Internacional de Educación Superior CiES",
  providerUrl: siteUrl
};

// FAQ se toma del JSON (si no hay, queda [])
const faq: FaqItem[] = programa.faq ?? [];

// Resolve el componente según la key
const ContentComponent = contentMap[programa.key] ?? null;
---

<BaseLayout
  title={title}
  description={description}
  canonical={pageUrl}
  type="article"
  image={programa.imgSrc}
  structuredData={{
    organization: true,
    breadcrumbs,
    course: courseData,
    faq
  }}
>
  <CiesSeccionProgramaHeader programa={programa} />
  <CiesSeccionProgramaForm programaKey={programa.key} />

  <div class="container my-5">
    <div class="row g-5">
      <div class="col-12">
        {ContentComponent && <ContentComponent />}
      </div>
    </div>
  </div>
  

  <script src="/js/views/programas.js" defer></script>
  <script>
    // @ts-ignore
    document.addEventListener("DOMContentLoaded", () => {
      ComponentPrograma.init({});
    });
  </script>
</BaseLayout>

